{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "combined_plan.schema.json",
  "type": "object",
  "required": ["spec_version", "metadata", "ops"],
  "properties": {
    "$schema": { "type": "string" },
    "spec_version": { "type": "string" },
    "metadata": {
      "type": "object",
      "required": ["name", "description"],
      "properties": {
        "name": { "type": "string" },
        "description": { "type": "string" },
        "target_repo": { "type": "string" },
        "generated_at": { "type": "string" }
      },
      "additionalProperties": true
    },
    "plan_fingerprint": {
      "type": "object",
      "properties": {
        "method": { "enum": ["sha256_ops"] },
        "value": { "type": "string", "pattern": "^[0-9a-f]{64}$" }
      },
      "additionalProperties": true
    },
    "paths_allowlist": { "type": "array", "items": { "type": "string" } },
    "paths_denylist": { "type": "array", "items": { "type": "string" } },
    "defaults": { "type": "object", "additionalProperties": true },
    "execution": {
      "type": "object",
      "required": ["dry_run", "phases"],
      "properties": {
        "dry_run": { "type": "boolean" },
        "phases": { "type": "array", "items": { "enum": ["validate", "apply"] } }
      },
      "additionalProperties": true
    },
    "ops": {
      "type": "array",
      "items": {
        "oneOf": [
          {
            "type": "object",
            "required": ["op", "id", "glob", "phase"],
            "properties": {
              "op": { "const": "locate" },
              "id": { "type": "string" },
              "glob": { "type": "string" },
              "must_contain": { "type": "array", "items": { "type": "string" } },
              "phase": { "const": "validate" }
            },
            "additionalProperties": true
          },
          {
            "type": "object",
            "required": ["op", "file", "must_contain", "phase"],
            "properties": {
              "op": { "const": "assert_contains" },
              "file": { "type": "string" },
              "must_contain": { "type": "array", "minItems": 1, "items": { "type": "string" } },
              "phase": { "const": "validate" }
            },
            "additionalProperties": true
          },
          {
            "type": "object",
            "required": ["op", "file", "must_not_contain", "phase"],
            "properties": {
              "op": { "const": "assert_not_contains" },
              "file": { "type": "string" },
              "must_not_contain": { "type": "array", "minItems": 1, "items": { "type": "string" } },
              "phase": { "const": "validate" }
            },
            "additionalProperties": true
          },
          {
            "type": "object",
            "required": ["op", "file", "start_regex", "end_regex", "replacement_base64", "phase", "dry_run_effect"],
            "properties": {
              "op": { "const": "replace_section" },
              "file": { "type": "string" },
              "start_regex": { "type": "string" },
              "end_regex": { "type": "string" },
              "replacement_base64": { "type": "string" },
              "allow_multiple_matches": { "type": "boolean", "default": false },
              "idempotency_marker": { "type": "string" },
              "on_duplicate": { "enum": ["skip", "error", "replace_again"], "default": "skip" },
              "verify_preview_sha256": { "type": "string", "pattern": "^[0-9a-f]{64}$" },
              "match_timeout_ms": { "type": "integer", "minimum": 0 },
              "phase": { "const": "apply" },
              "dry_run_effect": { "const": "scan_only" }
            },
            "additionalProperties": true
          },
          {
            "type": "object",
            "required": ["op", "path", "content_base64", "checksum_sha256", "if_exists", "phase", "dry_run_effect"],
            "properties": {
              "op": { "const": "write_file" },
              "path": { "type": "string" },
              "content_base64": { "type": "string" },
              "checksum_sha256": { "type": "string", "pattern": "^[0-9a-f]{64}$" },
              "expected_sha256_before": { "type": "string", "pattern": "^[0-9a-f]{64}$" },
              "normalize_eol": { "enum": ["preserve", "lf", "crlf"], "default": "preserve" },
              "encoding": { "enum": ["utf-8", "utf-8-sig"], "default": "utf-8" },
              "if_exists": { "enum": ["skip", "overwrite", "error"] },
              "phase": { "const": "apply" },
              "dry_run_effect": { "const": "noop" },
              "source": { "type": "string" }
            },
            "additionalProperties": true
          }
        ]
      }
    }
  },
  "additionalProperties": true
}
